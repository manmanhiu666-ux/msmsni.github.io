<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è©èªå¤§å¸«ï¼šç­†å¢¨å‚³å¥‡</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <style>
        /* =========================================
           è‡ªè¨‚å­—é«”è¨­å®š
           ========================================= */
        @font-face {
            font-family: 'HKKai';
            src: url('./Free-HK-Kai_4700-v1.02.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-image: url('./chii.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            
            font-family: 'HKKai', 'KaiTi', 'BiauKai', serif;
            touch-action: pan-x pan-y;
        }

        button, input, select, textarea {
            font-family: 'HKKai', 'KaiTi', 'BiauKai', serif !important;
        }

        .calligraphy-font {
            font-family: 'HKKai', cursive;
        }

        .mizige {
            background-color: white;
            background-image: 
                linear-gradient(45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(to right, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%),
                linear-gradient(to bottom, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 2px solid #b91c1c;
            touch-action: none !important; 
        }

        .writing-canvas-container canvas, 
        .writing-canvas-container svg {
            touch-action: none !important;
        }

        /* æ‰£åˆ†å‹•ç•«ç‰¹æ•ˆ */
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-30px) scale(1); }
        }

        .deduction-feedback {
            animation: floatUpFade 0.8s ease-out forwards;
            color: #ef4444;
            font-weight: 900;
            font-size: 3rem; 
            position: absolute;
            top: 0px;
            right: 0px;
            pointer-events: none;
            z-index: 50;
            text-shadow: 3px 3px 0px white;
            font-family: sans-serif;
        }

        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s ease-out forwards;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // è€å¸«è¨­å®šå€
        // ==========================================
        const UNIT_DATA = [
            {
                id: 9,
                title: "ç¬¬ä¹èª²",
                subtitle: "æœ›æ¢…æ­¢æ¸´",
                words: [
                    { id: 901, word: "æ”»æ‰“", emoji: "âš”ï¸", jyutping: "gung1 daa2", meaning: "è»äº‹ä¸Šçš„é€²æ”»ã€‚", english_meaning: "To attack (militarily).", sentence: "è»éšŠæº–å‚™____æ•µäººçš„åŸå ¡ã€‚", tip: "ã€Œæ”»ã€å·¦é‚Šæ˜¯å·¥ï¼Œå³é‚Šæ˜¯æ”´(æ”µ)ã€‚" },
                    { id: 902, word: "é£›æš", emoji: "ğŸš©", jyutping: "fei1 joeng4", meaning: "é«˜é«˜é£„èˆã€‚", english_meaning: "To flutter; To fly upward.", sentence: "é®®è±”çš„æ——å¹Ÿåœ¨é¢¨ä¸­____ã€‚", tip: "ã€Œæšã€æ˜¯ææ‰‹æ—ã€‚" },
                    { id: 903, word: "çƒˆæ—¥ç•¶ç©º", emoji: "â˜€ï¸", jyutping: "lit6 jat6 dong1 hung1", meaning: "ç‚ç†±çš„å¤ªé™½é«˜æ›å¤©ç©ºã€‚", english_meaning: "Scorching sun high in the sky.", sentence: "____çš„ä¸­åˆï¼Œå¤§å®¶éƒ½èº²åœ¨æ¨¹è”­ä¸‹ã€‚", tip: "ã€Œçƒˆã€ä¸‹é¢æ˜¯å››é»ç«ã€‚" },
                    { id: 904, word: "å£ä¹¾èˆŒç‡¥", emoji: "ğŸ¥µ", jyutping: "hau2 gon1 sit6 cou3", meaning: "å½¢å®¹éå¸¸å£æ¸´ã€‚", english_meaning: "Dry mouth and parched tongue.", sentence: "ä»–åœ¨æ²™æ¼ èµ°äº†å¾ˆä¹…ï¼Œæ„Ÿåˆ°____ã€‚", tip: "ã€Œç‡¥ã€æ˜¯ç«å­—æ—ï¼Œå½¢å®¹ä¹¾ç‡¥ã€‚" },
                    { id: 905, word: "æ¶ˆæ²‰", emoji: "ğŸ˜", jyutping: "siu1 cam4", meaning: "æƒ…ç·’ä½è½ã€‚", english_meaning: "Depressed; Low-spirited.", sentence: "å¤±æ•—ä¸¦æ²’æœ‰è®“ä»–æ„å¿—____ï¼Œåè€Œæ›´åŠªåŠ›ã€‚", tip: "ã€Œæ²‰ã€æ˜¯ä¸‰é»æ°´ã€‚" },
                    { id: 906, word: "æ¿€å‹µ", emoji: "ğŸ’ª", jyutping: "gik1 lai6", meaning: "æ¿€ç™¼é¼“å‹µã€‚", english_meaning: "To encourage; To inspire.", sentence: "è€å¸«çš„è©±æ·±æ·±____äº†æˆ‘å€‘ã€‚", tip: "ã€Œå‹µã€å³é‚Šæ˜¯åŠ›ã€‚" },
                    { id: 907, word: "æ¿•æ½¤", emoji: "ğŸ’§", jyutping: "sap1 jeon6", meaning: "æ½®æ¿•è€Œæ½¤æ¾¤ã€‚", english_meaning: "Moist.", sentence: "é›¨å¾Œçš„ç©ºæ°£ç‰¹åˆ¥____æ¸…æ–°ã€‚", tip: "å…©å€‹å­—éƒ½æ˜¯ä¸‰é»æ°´ã€‚" },
                    { id: 908, word: "ç²¾ç¥æŠ–æ“»", emoji: "ğŸ¦", jyutping: "zing1 san4 dau2 sau2", meaning: "ç²¾ç¥é£½æ»¿ï¼Œå……æ»¿æ´»åŠ›ã€‚", english_meaning: "Spirited; Vigorous.", sentence: "é‹å‹•å“¡å€‹å€‹____åœ°æ­¥å…¥æœƒå ´ã€‚", tip: "ã€ŒæŠ–ã€å’Œã€Œæ“»ã€éƒ½æ˜¯ææ‰‹æ—ã€‚" }
                ]
            },
            {
                id: 10,
                title: "ç¬¬åèª²",
                subtitle: "ç•«é¾é»ç›",
                words: [
                    { id: 1001, word: "é«˜è¶…", emoji: "ğŸ§™â€â™‚ï¸", jyutping: "gou1 ciu1", meaning: "å½¢å®¹æŠ€è¡“ç‰¹åˆ¥å¥½ã€‚", english_meaning: "Superb; Masterly.", sentence: "é€™ä½é­”è¡“å¸«çš„è®Šé­”è¡“æŠ€å·§ååˆ†____ã€‚", tip: "æ³¨æ„ã€Œé«˜ã€çš„ä¸Šä¸‹çµæ§‹ã€‚" },
                    { id: 1002, word: "æ ©æ ©å¦‚ç”Ÿ", emoji: "ğŸ¯", jyutping: "heoi2 heoi2 jyu4 sang1", meaning: "å½¢å®¹è—è¡“ä½œå“éå¸¸é€¼çœŸã€‚", english_meaning: "Lifelike; Vivid.", sentence: "ç•«å®¶ç­†ä¸‹çš„è€è™____ã€‚", tip: "ã€Œæ ©ã€æ˜¯æœ¨å­—æ—ã€‚" },
                    { id: 1003, word: "è®šä¸çµ•å£", emoji: "ğŸ‘", jyutping: "zaan3 bat1 zyut6 hau2", meaning: "ä¸åœåœ°ç¨±è®šã€‚", english_meaning: "Full of praise.", sentence: "å¥¶å¥¶åšçš„èœå¤ªå¥½åƒäº†ï¼Œå¤§å®¶éƒ½____ã€‚", tip: "ã€Œè®šã€å…ˆå¯«è¨€ï¼Œå†å¯«å…©å€‹å…ˆã€‚" },
                    { id: 1004, word: "å—é‚€", emoji: "ğŸ“©", jyutping: "sau6 jiu1", meaning: "æ¥å—é‚€è«‹ã€‚", english_meaning: "Invited.", sentence: "ä»–____åƒåŠ é€™æ¬¡çš„åœ‹éš›è«–å£‡ã€‚", tip: "ã€Œé‚€ã€è£¡é¢æ˜¯ã€Œæ•«ã€ã€‚" },
                    { id: 1005, word: "åæšå››æµ·", emoji: "ğŸŒ", jyutping: "ming4 joeng4 sei3 hoi2", meaning: "åè²å‚³éå„åœ°ã€‚", english_meaning: "World famous.", sentence: "é€™ä½é‹¼ç´å®¶å·²ç¶“____ã€‚", tip: "ã€Œæšã€æ˜¯ææ‰‹æ—ã€‚" },
                    { id: 1006, word: "å°‡ä¿¡å°‡ç–‘", emoji: "ğŸ¤¨", jyutping: "zoeng1 seon3 zoeng1 ji4", meaning: "æœ‰é»ç›¸ä¿¡ï¼Œåˆæœ‰é»æ‡·ç–‘ã€‚", english_meaning: "Half believing, half doubting.", sentence: "å°æ–¼é€™å‰‡èª‡å¼µçš„æ–°èï¼Œå¤§å®¶éƒ½____ã€‚", tip: "ã€Œç–‘ã€å³é‚Šæ˜¯åŒ•ã€çŸ¢ã€èµ°ã€‚" },
                    { id: 1007, word: "ç°‡æ“", emoji: "ğŸ‘¥", jyutping: "cuk1 jung2", meaning: "è¨±å¤šäººåœ˜åœ˜åœè‘—ã€‚", english_meaning: "To crowd around.", sentence: "å¤§æ˜æ˜Ÿè¢«ç²‰çµ²____è‘—ã€‚", tip: "ã€Œç°‡ã€ä¸Šç«¹ä¸‹æ—ã€‚" },
                    { id: 1008, word: "çƒé›²å¯†ä½ˆ", emoji: "â˜ï¸", jyutping: "wu1 wan4 mat6 bou3", meaning: "é»‘é›²ä½ˆæ»¿å¤©ç©ºã€‚", english_meaning: "Dark clouds gathering.", sentence: "å¤©ç©ºä¸­____ï¼Œè¦ä¸‹é›¨äº†ã€‚", tip: "ã€Œçƒã€è£¡é¢æ²’æœ‰é»ã€‚" }
                ]
            }
        ];

        // -----------------------
        // çµ„ä»¶ï¼šç­†é †æ¼”ç¤ºè¦–çª— (Stroke Order Demo Modal)
        // -----------------------
        const StrokeOrderDemoModal = ({ word, englishMeaning, onClose }) => {
            const containerRef = useRef(null);
            const writersRef = useRef([]);

            useEffect(() => {
                if (containerRef.current && window.HanziWriter) {
                    containerRef.current.innerHTML = "";
                    writersRef.current = [];
                    const chars = word.split('');
                    
                    chars.forEach((char) => {
                        const div = document.createElement('div');
                        div.className = "mizige rounded-lg bg-white inline-block m-1 shadow-md";
                        const size = window.innerWidth < 640 ? 80 : 150;
                        div.style.width = `${size}px`;
                        div.style.height = `${size}px`;
                        
                        containerRef.current.appendChild(div);

                        const writer = HanziWriter.create(div, char, {
                            width: size,
                            height: size,
                            padding: 5,
                            showOutline: true,
                            strokeAnimationSpeed: 1, 
                            delayBetweenStrokes: 200,
                            strokeColor: '#1e3a8a',
                            fontFamily: 'HKKai',
                        });
                        writersRef.current.push(writer);
                    });
                }
            }, [word]);

            const playAnimation = () => {
                if (writersRef.current.length === 0) return;
                let promiseChain = Promise.resolve();
                writersRef.current.forEach(writer => { promiseChain = promiseChain.then(() => writer.animateCharacter()); });
            };

            return (
                <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-4xl w-full p-6 border-4 border-amber-200 relative overflow-hidden">
                        <div className="text-center mb-6">
                            <h3 className="text-3xl font-bold text-amber-900 mb-1">ğŸ‘ï¸ ç­†é †æ¼”ç¤º</h3>
                            <p className="text-2xl text-amber-700 font-bold mb-4 font-sans">{englishMeaning}</p>
                            <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-red-600 text-lg font-bold">
                                âš ï¸ æ³¨æ„ï¼šé—œé–‰æ­¤è¦–çª—å¾Œï¼Œç„¡æ³•å†æ¬¡è§€çœ‹ç­†é †ï¼
                            </div>
                        </div>
                        <div ref={containerRef} className="flex flex-wrap justify-center mb-8 gap-2 min-h-[100px]"></div>
                        <div className="flex flex-col md:flex-row gap-4 justify-center">
                            <button onClick={playAnimation} className="flex items-center justify-center gap-2 px-8 py-4 bg-gray-100 text-gray-600 rounded-2xl text-xl font-bold transition hover:bg-gray-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                æ’­æ”¾ (Play)
                            </button>
                            <button onClick={onClose} className="flex items-center justify-center gap-2 px-10 py-4 bg-amber-500 text-white rounded-2xl text-xl font-bold shadow-lg transform transition hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                æˆ‘è¨˜ä½äº†ï¼Œé–‹å§‹æ›¸å¯«ï¼
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // -----------------------
        // å–®å­—ç·´ç¿’æ ¼çµ„ä»¶
        // -----------------------
        const CharacterBox = ({ char, onScoreChange, onComplete }) => {
            const boxRef = useRef(null);
            const writerRef = useRef(null);
            const [localScore, setLocalScore] = useState(100);
            const [status, setStatus] = useState('ready'); 
            const [boxSize, setBoxSize] = useState(200); 
            const [deductions, setDeductions] = useState([]); 

            useEffect(() => {
                const updateSize = () => {
                    const width = window.innerWidth;
                    if (width < 640) {
                        const calculatedSize = Math.floor((width - 16) / 4);
                        setBoxSize(Math.max(calculatedSize, 70)); 
                    } else {
                        setBoxSize(220);
                    }
                };
                updateSize(); 
                window.addEventListener('resize', updateSize); 
                return () => window.removeEventListener('resize', updateSize);
            }, []);

            useEffect(() => {
                if (boxRef.current && window.HanziWriter) {
                    boxRef.current.innerHTML = "";
                    setLocalScore(100);
                    setStatus('ready');
                    try {
                        writerRef.current = HanziWriter.create(boxRef.current, char, {
                            width: boxSize, height: boxSize, padding: 3, showOutline: true, showCharacter: false, showHintAfterMisses: 3, 
                            strokeColor: '#1e3a8a', outlineColor: '#d1d5db', highlightColor: '#10b981', fontFamily: 'HKKai',
                        });
                        startQuiz();
                    } catch (e) { if (onComplete) onComplete(); }
                }
            }, [char, boxSize]);

            const startQuiz = () => {
                if (!writerRef.current) return;
                setStatus('writing');
                writerRef.current.quiz({
                    onMistake: () => {
                        setLocalScore(p => { 
                            const n = Math.max(0, p - 10); 
                            onScoreChange(char, n); 
                            return n; 
                        });
                        const id = Date.now();
                        setDeductions(prev => [...prev, { id }]);
                        setTimeout(() => {
                            setDeductions(prev => prev.filter(d => d.id !== id));
                        }, 1000);
                    },
                    onComplete: () => {
                        setStatus('scoring');
                        setTimeout(() => {
                            setStatus('show_char');
                            if(writerRef.current) writerRef.current.showCharacter({ animation: false }); 
                        }, 3000); 
                        if (onComplete) onComplete();
                    }
                });
            };

            return (
                <div className="flex flex-col items-center">
                    <div className="relative shadow-md group">
                        {deductions.map(d => (
                            <div key={d.id} className="deduction-feedback" style={{ top: '0px', right: '0px' }}>
                                -10
                            </div>
                        ))}

                        <div className="mizige relative overflow-hidden rounded-md bg-white cursor-crosshair writing-canvas-container"
                             style={{ width: `${boxSize}px`, height: `${boxSize}px` }}>
                            <div ref={boxRef} className="absolute inset-0 w-full h-full flex justify-center items-center svg-container"></div>
                            {status === 'scoring' && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none fade-in z-20">
                                    <div className="border-4 border-red-500 rounded-full flex items-center justify-center transform -rotate-12 bg-white/80 backdrop-blur-sm shadow-lg"
                                         style={{ width: `${boxSize * 0.7}px`, height: `${boxSize * 0.7}px` }}>
                                        <div className="text-center"><span className="block text-red-600 font-bold font-serif" style={{ fontSize: `${boxSize * 0.35}px` }}>{localScore}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // -----------------------
        // å¯«å­—ç·´ç¿’å€å¡Š
        // -----------------------
        const WordPractice = ({ wordData, onWordComplete, onScoreUpdate }) => {
            const chars = wordData.word.split('');
            const [resetSignal, setResetSignal] = useState(0);
            const [scores, setScores] = useState({});
            const [completedIndices, setCompletedIndices] = useState(new Set());

            const handleScoreChangeIndexed = (index, score) => setScores(p => ({ ...p, [index]: score }));
            const handleCharComplete = (index) => {
                setCompletedIndices(p => {
                    const n = new Set(p); n.add(index);
                    if (n.size === chars.length) onWordComplete(true);
                    return n;
                });
            };
            const calculateAverage = () => {
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                return chars.length === 0 ? 0 : Math.round(total / chars.length);
            };

            useEffect(() => {
                if (onScoreUpdate) {
                    onScoreUpdate(calculateAverage());
                }
            }, [scores]);

            useEffect(() => { const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set()); }, [wordData]);

            return (
                <div className="flex flex-col items-center w-full">
                    <div className="w-full flex justify-between items-center bg-white/90 px-4 py-2 rounded-xl mb-2 border-2 border-amber-200">
                         <span className="text-sm text-amber-700 font-bold">ç›®å‰ç¸½åˆ†</span>
                         <span className="text-2xl font-bold text-amber-900 font-mono">{calculateAverage()}</span>
                    </div>
                    
                    <div className="flex flex-wrap justify-center gap-0.5 md:gap-3 mb-2 w-full">
                        {chars.map((char, index) => (
                            <CharacterBox key={`${wordData.id}-${index}-${char}`} char={char} 
                                onScoreChange={(c, s) => handleScoreChangeIndexed(index, s)} onComplete={() => handleCharComplete(index)} />
                        ))}
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => { setResetSignal(p => p + 1); const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set()); onWordComplete(false); }}
                            className="px-4 py-2 rounded-xl text-md font-bold transition shadow-sm bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-200">
                            é‡å¯« (Reset)
                        </button>
                    </div>
                </div>
            );
        };

        // -----------------------
        // ä¸»æ‡‰ç”¨ç¨‹å¼
        // -----------------------
        const App = () => {
            const [playerName, setPlayerName] = useState('');
            const [inputName, setInputName] = useState('');
            const [currentUnit, setCurrentUnit] = useState(null); 
            const [mode, setMode] = useState('welcome'); 
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0); // é€™è£¡çš„åˆ†æ•¸æœƒæ˜¯å°æ•¸
            const [showResult, setShowResult] = useState(false);
            const [feedback, setFeedback] = useState(null); 
            const [quizOptions, setQuizOptions] = useState([]);
            const [canProceed, setCanProceed] = useState(false);
            const [audioSpeed, setAudioSpeed] = useState(1); 
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [showDemoModal, setShowDemoModal] = useState(false);
            
            const [studyScores, setStudyScores] = useState({});

            const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);

            const handleLogin = (e) => {
                e.preventDefault();
                if (inputName.trim()) {
                    setPlayerName(inputName.trim());
                    setMode('unit_select');
                }
            };

            const handleUnitSelect = (unit) => {
                if (unit.words.length === 0) { alert("æ­¤èª²å ‚å…§å®¹å°šæœªæ›´æ–°ï¼Œè«‹ç¨å¾Œå†ä¾†ï¼"); return; }
                setCurrentUnit(unit);
                setMode('menu');
            };

            const startStudy = () => { 
                setMode('study'); setCurrentIndex(0); setCanProceed(false); setShowDemoModal(true); 
                setStudyScores({}); 
            };
            
            const handleStudyScoreUpdate = (wordScore) => {
                setStudyScores(prev => ({...prev, [currentIndex]: wordScore}));
            };

            const startQuiz = () => { setMode('quiz'); setScore(0); setCurrentIndex(0); setShowResult(false); prepareQuizRound(0); };

            const prepareQuizRound = (index) => {
                if (!currentUnit) return;
                const vocabList = currentUnit.words;
                if (index >= vocabList.length) { setShowResult(true); return; }
                const correctWord = vocabList[index];
                let options = vocabList.filter(v => v.id !== correctWord.id);
                if (options.length > 3) options = shuffleArray(options).slice(0, 3);
                options.push(correctWord);
                setQuizOptions(shuffleArray(options));
            };

            const handleQuizAnswer = (selectedWord) => {
                if (!currentUnit) return;
                const currentWord = currentUnit.words[currentIndex];
                
                // å‹•æ…‹è¨ˆç®—æ¯é¡Œåˆ†æ•¸ï¼š100åˆ† / ç¸½é¡Œæ•¸
                const pointsPerQuestion = 100 / currentUnit.words.length;

                if (selectedWord.id === currentWord.id) {
                    // ç­”å°åŠ åˆ†
                    setScore(prev => prev + pointsPerQuestion);
                    setFeedback('correct');
                } else {
                    setFeedback('wrong');
                }
                setTimeout(() => {
                    setFeedback(null);
                    const nextIndex = currentIndex + 1;
                    setCurrentIndex(nextIndex);
                    prepareQuizRound(nextIndex);
                }, 1000);
            };

            const playCantonese = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                setIsSpeaking(true);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK'; utterance.rate = audioSpeed; 
                const voices = window.speechSynthesis.getVoices();
                const cantoneseVoice = voices.find(v => v.lang === 'zh-HK' || v.name.includes('Cantonese'));
                if (cantoneseVoice) utterance.voice = cantoneseVoice;
                utterance.onend = () => setIsSpeaking(false);
                window.speechSynthesis.speak(utterance);
            };

            useEffect(() => { if (window.speechSynthesis) window.speechSynthesis.getVoices(); }, []);

            const getResultFeedback = (finalScore, totalScore) => {
                const percentage = (finalScore / totalScore) * 100;
                if (percentage >= 100) return { text: "å®Œç¾ï¼ä½ æ˜¯è©èªå¤§å¸«ï¼", emoji: "ğŸŒŸğŸ†ğŸ’¯" };
                if (percentage >= 80) return { text: "å¤ªæ£’äº†ï¼åšå¾—å¾ˆå¥½ï¼", emoji: "ğŸ‰âœ¨ğŸ˜Š" };
                if (percentage >= 60) return { text: "ä¸éŒ¯å–”ï¼ç¹¼çºŒåŠ æ²¹ï¼", emoji: "ğŸ’ªğŸ‘" };
                return { text: "åˆ¥æ°£é¤’ï¼Œå¤šç·´ç¿’æœƒæ›´å¥½çš„ï¼", emoji: "ğŸ“šğŸ”¥" };
            };

            // 0. æ­¡è¿ç™»å…¥é 
            if (mode === 'welcome') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white/90 p-8 rounded-3xl shadow-xl w-full max-w-sm border-4 border-amber-200">
                            <div className="w-48 h-48 bg-gray-200 rounded-full mx-auto mb-6 flex items-center justify-center overflow-hidden border-4 border-amber-300 relative">
                                <img src="./profile.jpg" onError={(e) => { e.target.onerror = null; e.target.src = "https://ui-avatars.com/api/?name=Ms+Ni&background=fcd34d&color=fff&size=128"; }} alt="Ms. Ni" className="w-full h-full object-cover" />
                            </div>
                            <h1 className="text-6xl text-amber-900 calligraphy-font text-center mb-2">è©èªå¤§å¸«</h1>
                            <h3 className="text-3xl text-amber-600 font-bold text-center mb-8">Ms. Ni çš„èª²å ‚</h3>
                            <form onSubmit={handleLogin} className="space-y-6">
                                <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} placeholder="è¼¸å…¥ä½ çš„åå­—" className="w-full px-6 py-4 text-2xl rounded-2xl border-2 border-amber-200 focus:outline-none bg-amber-50/80 text-amber-900 text-center" required />
                                <button type="submit" className="w-full bg-amber-500 hover:bg-amber-600 text-white text-2xl py-4 rounded-2xl font-bold shadow-md active:scale-95">é–‹å§‹éŠæˆ²</button>
                            </form>
                        </div>
                    </div>
                );
            }

            // 1. èª²å ‚é¸æ“‡é 
            if (mode === 'unit_select') {
                return (
                    <div className="min-h-screen flex flex-col items-center p-4">
                        <div className="w-full max-w-md animate-bounce-in relative">
                            <button onClick={() => setMode('welcome')} className="absolute -top-14 left-0 text-amber-900 font-bold flex items-center gap-1 bg-white/80 px-4 py-2 rounded-xl text-lg shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                ç™»å‡º
                            </button>
                            <h2 className="text-4xl text-amber-900 calligraphy-font text-center mb-2 drop-shadow-sm mt-4">è«‹é¸æ“‡èª²å ‚</h2>
                            <p className="text-xl text-center text-amber-700 font-bold mb-8 drop-shadow-sm">ä½ å¥½ï¼Œ{playerName}</p>
                            <div className="space-y-6">
                                {UNIT_DATA.map(unit => (
                                    <button key={unit.id} onClick={() => handleUnitSelect(unit)} className={`w-full p-8 rounded-3xl shadow-lg border-2 text-left flex flex-col gap-2 transition transform ${unit.words.length === 0 ? 'bg-gray-100 border-gray-200 opacity-70 cursor-not-allowed' : 'bg-white/90 border-amber-200 hover:scale-105'}`}>
                                        <div className="flex justify-between items-center"><span className="text-3xl font-bold text-amber-900">{unit.title}</span>{unit.words.length === 0 && <span className="text-sm bg-gray-300 text-gray-600 px-3 py-1 rounded-lg">å³å°‡æ¨å‡º</span>}</div>
                                        {unit.subtitle && <span className="text-xl text-amber-700 font-bold">{unit.subtitle}</span>}
                                        <span className="text-lg text-gray-500">{unit.description}</span>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setMode('welcome')} className="w-full mt-10 py-4 bg-gray-100/90 text-gray-600 rounded-2xl font-bold text-xl flex items-center justify-center gap-2 hover:opacity-80 transition shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                è¿”å›é¦–é  (Back)
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. é¸å–®ä»‹é¢
            if (mode === 'menu') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="text-center w-full max-w-md animate-bounce-in relative">
                            <button onClick={() => setMode('unit_select')} className="absolute -top-20 left-0 text-amber-900 font-bold flex items-center gap-1 bg-white/80 px-4 py-2 rounded-xl text-lg shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                è¿”å›èª²å ‚åˆ—è¡¨
                            </button>
                            <h1 className="text-5xl text-amber-900 font-bold mb-2 drop-shadow-sm">{currentUnit.title}</h1>
                            <h2 className="text-6xl text-amber-900 calligraphy-font mb-6 drop-shadow-sm">{currentUnit.subtitle}</h2>
                            <p className="text-2xl text-amber-900 mb-10 drop-shadow-sm">{currentUnit.description}</p>
                            <div className="space-y-6">
                                <button onClick={startStudy} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white text-3xl py-6 rounded-3xl shadow-xl active:scale-95 font-bold flex items-center justify-center gap-3">å¯«å­—é“å ´ <span className="text-xl opacity-70">(Writing)</span></button>
                                <button onClick={startQuiz} className="w-full bg-amber-500 hover:bg-amber-600 text-white text-3xl py-6 rounded-3xl shadow-xl active:scale-95 font-bold flex items-center justify-center gap-3">è©ç¾©æŒ‘æˆ° <span className="text-xl opacity-70">(Quiz)</span></button>
                            </div>
                        </div>
                    </div>
                );
            }

            // 3. å¯«å­—ç·´ç¿’æ¨¡å¼
            if (mode === 'study') {
                const vocabList = currentUnit.words;
                const wordData = vocabList[currentIndex];
                return (
                    <div className="h-screen flex flex-col overflow-hidden relative">
                        {showDemoModal && (
                            <StrokeOrderDemoModal 
                                word={wordData.word} 
                                englishMeaning={wordData.english_meaning}
                                onClose={() => setShowDemoModal(false)}
                            />
                        )}

                        <div className="flex justify-between items-center px-4 py-3 bg-white/90 shadow-md shrink-0 z-10">
                            <button onClick={() => setMode('menu')} className="text-amber-700 font-bold text-xl flex items-center gap-2 bg-amber-50 px-4 py-2 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                é€€å‡º
                            </button>
                            <span className="text-2xl font-bold text-amber-900">{currentIndex + 1} / {vocabList.length}</span>
                            <div className="w-20"></div>
                        </div>
                        
                        <div className="flex-1 p-0 md:p-4 flex items-center justify-center overflow-hidden">
                            <div className="w-full h-full bg-white/90 rounded-none md:rounded-3xl shadow-xl p-2 md:p-6 flex flex-col overflow-y-auto">
                                <div className="flex flex-col lg:flex-row gap-6 flex-1">
                                    <div className="w-full lg:w-[35%] flex flex-col gap-4 justify-center">
                                        <div className="flex items-center justify-between md:justify-start gap-4">
                                            <h2 className="text-5xl md:text-5xl font-bold text-amber-900">{wordData.word}</h2>
                                            <div className="flex gap-2">
                                                <button onClick={() => playCantonese(wordData.word)} className={`p-3 rounded-full ${isSpeaking ? 'bg-amber-400' : 'bg-gray-100'} hover:bg-amber-200 transition`}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                                                </button>
                                                <button onClick={() => setAudioSpeed(audioSpeed === 1 ? 0.5 : 1)} className="px-3 py-1 text-sm font-bold rounded-lg border-2 border-gray-200 bg-gray-50 text-gray-600">{audioSpeed === 1 ? 'æ­£å¸¸' : 'æ…¢é€Ÿ'}</button>
                                            </div>
                                        </div>
                                        <div className="text-xl font-bold text-amber-800 bg-amber-50 px-3 py-2 rounded-xl w-fit">ç²µ: {wordData.jyutping}</div>
                                        <div className="text-lg text-gray-700 bg-gray-50 border-gray-200 border-2 p-3 rounded-xl"><span className="font-bold block text-xs text-gray-400 uppercase mb-1">Meaning</span>{wordData.meaning}</div>
                                        <div className="text-lg text-indigo-700 bg-indigo-50 border-indigo-200 border-2 p-3 rounded-xl"><span className="font-bold block text-xs text-indigo-300 uppercase mb-1">English</span>{wordData.english_meaning}</div>
                                    </div>
                                    <div className="w-full lg:w-[65%] border-t-2 lg:border-t-0 lg:border-l-2 border-gray-100 pt-6 lg:pt-0 lg:pl-6 flex flex-col justify-center">
                                        <WordPractice wordData={wordData} onWordComplete={setCanProceed} onScoreUpdate={handleStudyScoreUpdate} key={wordData.id} />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="shrink-0 p-4 bg-white/95 border-t-2 border-amber-200 flex justify-between items-center gap-6 z-20">
                            <button onClick={() => { setCurrentIndex(Math.max(0, currentIndex - 1)); setCanProceed(false); setShowDemoModal(true); }} disabled={currentIndex === 0} className={`px-6 py-5 rounded-2xl font-bold text-xl ${currentIndex === 0 ? 'bg-gray-100 text-gray-300' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>ä¸Šä¸€å€‹</button>
                            <button onClick={() => { if (currentIndex < vocabList.length - 1) { setCurrentIndex(currentIndex + 1); setCanProceed(false); setShowDemoModal(true); } else { setMode('study_result'); } }}
                                disabled={!canProceed} className={`flex-1 py-5 rounded-2xl font-bold shadow-lg transition text-2xl flex justify-center items-center gap-3 ${canProceed ? 'bg-amber-500 hover:bg-amber-600 text-white active:scale-95' : 'bg-gray-200 text-gray-400'}`}>
                                {!canProceed && "ğŸ”’ "} {currentIndex === vocabList.length - 1 ? 'å®Œæˆç·´ç¿’' : 'ä¸‹ä¸€å€‹'}
                            </button>
                        </div>
                    </div>
                );
            }

            // æ–°å¢ï¼šå¯«å­—ç·´ç¿’çµç®—é é¢
            if (mode === 'study_result') {
                const totalScore = Object.values(studyScores).reduce((a, b) => a + b, 0);
                const count = Object.keys(studyScores).length || 1;
                const finalAverage = Math.round(totalScore / count);
                const feedbackData = getResultFeedback(finalAverage, 100);

                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white/95 p-10 rounded-[2rem] shadow-2xl text-center w-full max-w-lg border-4 border-amber-200 animate-bounce-in">
                            <h2 className="text-4xl font-bold text-amber-900 mb-2">å¯«å­—é“å ´ ç·´ç¿’å®Œæˆï¼</h2>
                            <p className="text-2xl text-amber-700 font-bold mb-8">{playerName}</p>
                            
                            <div className="mb-10">
                                <div className="text-8xl mb-4">{feedbackData.emoji}</div>
                                <div className="text-2xl text-gray-500 mb-2">ç¸½å¹³å‡åˆ†</div>
                                <div className="text-8xl font-bold text-amber-900">{finalAverage}</div>
                            </div>
                            
                            <div className="bg-amber-50 p-6 rounded-2xl mb-10">
                                <p className="text-amber-900 font-bold text-2xl">{feedbackData.text}</p>
                            </div>
                            
                            <button onClick={() => setMode('menu')} className="w-full bg-amber-500 hover:bg-amber-600 text-white text-3xl py-6 rounded-3xl font-bold shadow-lg transform transition active:scale-95">
                                è¿”å›èª²å ‚é¸å–®
                            </button>
                        </div>
                    </div>
                );
            }

            if (mode === 'quiz') {
                const vocabList = currentUnit.words;
                if (showResult) {
                    // 100åˆ†åˆ¶ï¼šç›´æ¥å–å››æ¨äº”å…¥å¾Œçš„æ•´æ•¸åˆ†æ•¸
                    const finalScore = Math.round(score);
                    const feedbackData = getResultFeedback(finalScore, 100);

                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4">
                            <div className="bg-white/95 p-10 rounded-[2rem] shadow-2xl text-center w-full max-w-lg border-4 border-amber-200 animate-bounce-in">
                                <h2 className="text-4xl font-bold text-amber-900 mb-2">{currentUnit.title} æŒ‘æˆ°å®Œæˆï¼</h2>
                                <p className="text-2xl text-amber-700 font-bold mb-8">{playerName}</p>
                                <div className="mb-10">
                                    <div className="text-8xl mb-4">{feedbackData.emoji}</div>
                                    <div className="text-7xl font-bold text-amber-900 mb-2">{finalScore} åˆ†</div>
                                    <div className="text-gray-500 text-xl">æ»¿åˆ†ï¼š100</div>
                                </div>
                                <div className="bg-amber-50 p-6 rounded-2xl mb-10"><p className="text-amber-900 font-bold text-2xl">{feedbackData.text}</p></div>
                                <button onClick={() => setMode('menu')} className="w-full bg-amber-500 hover:bg-amber-600 text-white text-3xl py-6 rounded-3xl font-bold shadow-lg transform transition active:scale-95">è¿”å›èª²å ‚é¸å–®</button>
                            </div>
                        </div>
                    );
                }
                const currentWord = vocabList[currentIndex];
                return (
                    <div className="h-screen flex flex-col">
                        <div className="flex justify-between items-center px-4 py-3 bg-white/90 shadow-md shrink-0 z-10">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setMode('menu')} className="text-amber-700 font-bold text-xl flex items-center gap-2 bg-amber-50 px-4 py-2 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    é€€å‡º
                                </button>
                                <span className="bg-orange-100 text-orange-800 px-4 py-2 rounded-xl text-xl font-bold">Q {currentIndex + 1}</span>
                            </div>
                            {/* é¡¯ç¤ºå››æ¨äº”å…¥å¾Œçš„åˆ†æ•¸ */}
                            <span className="font-bold text-amber-900 text-xl">Score: {Math.round(score)}</span>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto">
                            <div className="w-full max-w-lg bg-white/95 rounded-3xl shadow-2xl p-8 border-4 border-amber-100">
                                <h3 className="text-4xl text-amber-900 leading-relaxed mb-4 text-center font-bold">
                                    {currentWord.sentence.split('____').map((part, i) => (<span key={i}>{part}{i === 0 && <span className="inline-block w-24 border-b-4 border-orange-400 mx-2 text-transparent">?</span>}</span>))}
                                </h3>
                                <p className="text-xl text-gray-500 text-center mb-8 bg-gray-50 py-2 rounded-lg">Hint: {currentWord.english_meaning}</p>
                                <div className="grid grid-cols-1 gap-4">
                                    {quizOptions.map((option) => (
                                        <button key={option.id} onClick={() => !feedback && handleQuizAnswer(option)} disabled={!!feedback} className={`p-6 text-3xl font-bold rounded-2xl border-4 transition flex items-center justify-center gap-4 shadow-sm ${feedback ? (option.id === currentWord.id ? 'bg-green-500 border-green-500 text-white' : 'bg-gray-100 text-gray-400') : 'bg-white border-amber-200 hover:border-amber-400 hover:bg-amber-50 text-amber-900'}`}>
                                            {option.emoji && <span className="text-4xl">{option.emoji}</span>} {option.word}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
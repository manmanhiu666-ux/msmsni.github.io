<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è©èªå¤§å¸«ï¼šç­†å¢¨å‚³å¥‡</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fef3c7;
            touch-action: pan-x pan-y;
        }
        .calligraphy-font {
            font-family: 'Zhi Mang Xing', cursive;
        }
        .mizige {
            background-color: white;
            background-image: 
                linear-gradient(45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(to right, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%),
                linear-gradient(to bottom, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 2px solid #b91c1c;
            touch-action: none !important; 
        }
        .writing-canvas-container canvas, 
        .writing-canvas-container svg {
            touch-action: none !important;
        }
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s ease-out forwards;
        }
        /* æ·¡å…¥å‹•ç•« */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // è€å¸«è¨­å®šå€ï¼šåœ¨æ­¤è™•æ–°å¢æˆ–ä¿®æ”¹èª²ç¨‹å…§å®¹
        // ==========================================
        const UNIT_DATA = [
            {
                id: 9,
                title: "ç¬¬ä¹èª²",
                subtitle: "æœ›æ¢…æ­¢æ¸´",
                description: "å­¸ç¿’ç¬¬ä¹èª²é‡é»è©èª",
                words: [
                    { id: 901, word: "æ”»æ‰“", emoji: "âš”ï¸", jyutping: "gung1 daa2", meaning: "è»äº‹ä¸Šçš„é€²æ”»ã€‚", english_meaning: "To attack (militarily).", sentence: "è»éšŠæº–å‚™____æ•µäººçš„åŸå ¡ã€‚", tip: "ã€Œæ”»ã€å·¦é‚Šæ˜¯å·¥ï¼Œå³é‚Šæ˜¯æ”´(æ”µ)ã€‚" },
                    { id: 902, word: "é£›æš", emoji: "ğŸš©", jyutping: "fei1 joeng4", meaning: "é«˜é«˜é£„èˆã€‚", english_meaning: "To flutter; To fly upward.", sentence: "é®®è±”çš„æ——å¹Ÿåœ¨é¢¨ä¸­____ã€‚", tip: "ã€Œæšã€æ˜¯ææ‰‹æ—ã€‚" },
                    { id: 903, word: "çƒˆæ—¥ç•¶ç©º", emoji: "â˜€ï¸", jyutping: "lit6 jat6 dong1 hung1", meaning: "ç‚ç†±çš„å¤ªé™½é«˜æ›å¤©ç©ºã€‚", english_meaning: "Scorching sun high in the sky.", sentence: "____çš„ä¸­åˆï¼Œå¤§å®¶éƒ½èº²åœ¨æ¨¹è”­ä¸‹ã€‚", tip: "ã€Œçƒˆã€ä¸‹é¢æ˜¯å››é»ç«ã€‚" },
                    { id: 904, word: "å£ä¹¾èˆŒç‡¥", emoji: "ğŸ¥µ", jyutping: "hau2 gon1 sit6 cou3", meaning: "å½¢å®¹éå¸¸å£æ¸´ã€‚", english_meaning: "Dry mouth and parched tongue.", sentence: "ä»–åœ¨æ²™æ¼ èµ°äº†å¾ˆä¹…ï¼Œæ„Ÿåˆ°____ã€‚", tip: "ã€Œç‡¥ã€æ˜¯ç«å­—æ—ï¼Œå½¢å®¹ä¹¾ç‡¥ã€‚" },
                    { id: 905, word: "æ¶ˆæ²‰", emoji: "ğŸ˜", jyutping: "siu1 cam4", meaning: "æƒ…ç·’ä½è½ã€‚", english_meaning: "Depressed; Low-spirited.", sentence: "å¤±æ•—ä¸¦æ²’æœ‰è®“ä»–æ„å¿—____ï¼Œåè€Œæ›´åŠªåŠ›ã€‚", tip: "ã€Œæ²‰ã€æ˜¯ä¸‰é»æ°´ã€‚" },
                    { id: 906, word: "æ¿€å‹µ", emoji: "ğŸ’ª", jyutping: "gik1 lai6", meaning: "æ¿€ç™¼é¼“å‹µã€‚", english_meaning: "To encourage; To inspire.", sentence: "è€å¸«çš„è©±æ·±æ·±____äº†æˆ‘å€‘ã€‚", tip: "ã€Œå‹µã€å³é‚Šæ˜¯åŠ›ã€‚" },
                    { id: 907, word: "æ¿•æ½¤", emoji: "ğŸ’§", jyutping: "sap1 jeon6", meaning: "æ½®æ¿•è€Œæ½¤æ¾¤ã€‚", english_meaning: "Moist.", sentence: "é›¨å¾Œçš„ç©ºæ°£ç‰¹åˆ¥____æ¸…æ–°ã€‚", tip: "å…©å€‹å­—éƒ½æ˜¯ä¸‰é»æ°´ã€‚" },
                    { id: 908, word: "ç²¾ç¥æŠ–æ“»", emoji: "ğŸ¦", jyutping: "zing1 san4 dau2 sau2", meaning: "ç²¾ç¥é£½æ»¿ï¼Œå……æ»¿æ´»åŠ›ã€‚", english_meaning: "Spirited; Vigorous.", sentence: "é‹å‹•å“¡å€‹å€‹____åœ°æ­¥å…¥æœƒå ´ã€‚", tip: "ã€ŒæŠ–ã€å’Œã€Œæ“»ã€éƒ½æ˜¯ææ‰‹æ—ã€‚" }
                ]
            },
            {
                id: 10,
                title: "ç¬¬åèª²",
                subtitle: "å¾…æ›´æ–°",
                description: "èª²ç¨‹å…§å®¹å³å°‡æ¨å‡º",
                words: [] // æš«æ™‚ç•™ç©º
            }
        ];

        // -----------------------
        // å–®å­—ç·´ç¿’æ ¼çµ„ä»¶ (å„ªåŒ–ç‰ˆï¼š3ç§’åˆ†æ•¸ -> é¡¯ç¤ºå®Œæ•´å­—é«”)
        // -----------------------
        const CharacterBox = ({ char, onScoreChange, resetSignal, onComplete }) => {
            const boxRef = useRef(null);
            const writerRef = useRef(null);
            const [localScore, setLocalScore] = useState(100);
            const [status, setStatus] = useState('ready'); // ready, writing, scoring(3s), show_char
            const [boxSize, setBoxSize] = useState(150); 

            useEffect(() => {
                const updateSize = () => {
                    const width = window.innerWidth;
                    if (width < 640) {
                        const calculatedSize = Math.floor((width - 40) / 3.5);
                        const finalSize = Math.min(Math.max(calculatedSize, 70), 90);
                        setBoxSize(finalSize); 
                    } else {
                        setBoxSize(150);
                    }
                };
                updateSize(); 
                window.addEventListener('resize', updateSize); 
                return () => window.removeEventListener('resize', updateSize);
            }, []);

            useEffect(() => {
                if (boxRef.current && window.HanziWriter) {
                    boxRef.current.innerHTML = "";
                    setLocalScore(100);
                    setStatus('ready');
                    try {
                        writerRef.current = HanziWriter.create(boxRef.current, char, {
                            width: boxSize, height: boxSize, padding: 3,
                            showOutline: true, showCharacter: false, showHintAfterMisses: 3, 
                            strokeColor: '#1e3a8a', outlineColor: '#d1d5db', highlightColor: '#10b981', 
                        });
                        startQuiz();
                    } catch (e) {
                        console.error("HanziWriter error:", e);
                        if (onComplete) onComplete();
                    }
                }
            }, [char, resetSignal, boxSize]);

            const startQuiz = () => {
                if (!writerRef.current) return;
                setStatus('writing');
                writerRef.current.quiz({
                    onMistake: () => setLocalScore(p => { const n = Math.max(0, p - 10); onScoreChange(char, n); return n; }),
                    onComplete: () => {
                        // 1. å¯«å®Œï¼Œé€²å…¥è¨ˆåˆ†ç‹€æ…‹ (é¡¯ç¤ºåˆ†æ•¸)
                        setStatus('scoring');
                        
                        // 2. è¨­ç½®å®šæ™‚å™¨ï¼Œ3ç§’å¾Œéš±è—åˆ†æ•¸ï¼Œé¡¯ç¤ºå®Œæ•´å­—é«”
                        setTimeout(() => {
                            setStatus('show_char');
                            if(writerRef.current) {
                                // å¼·åˆ¶é¡¯ç¤ºå®Œæ•´å­—é«”
                                writerRef.current.showCharacter({ animation: false }); // animation: false ç‚ºç«‹å³é¡¯ç¤º
                            }
                        }, 3000);

                        // 3. é€šçŸ¥çˆ¶å±¤å·²å®Œæˆ (é€™å¯ä»¥ç«‹å³è§¸ç™¼ï¼Œæˆ–æ”¾åœ¨ timeout è£¡ï¼Œé€™è£¡é¸æ“‡ç«‹å³è§¸ç™¼ä»¥å…é˜»ç¤™æµç¨‹)
                        if (onComplete) onComplete();
                    }
                });
            };

            return (
                <div className="flex flex-col items-center m-1">
                    <div className="relative shadow-md group">
                        <div className="mizige relative overflow-hidden rounded-md bg-white cursor-crosshair writing-canvas-container"
                             style={{ width: `${boxSize}px`, height: `${boxSize}px` }}>
                            <div ref={boxRef} className="absolute inset-0 w-full h-full flex justify-center items-center svg-container"></div>
                            
                            {/* ç‹€æ…‹ï¼šScoring (åªé¡¯ç¤º3ç§’) */}
                            {status === 'scoring' && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none fade-in z-20">
                                    <div className="border-4 border-red-500 rounded-full flex items-center justify-center transform -rotate-12 bg-white/80 backdrop-blur-sm shadow-lg"
                                         style={{ width: `${boxSize * 0.7}px`, height: `${boxSize * 0.7}px` }}>
                                        <div className="text-center">
                                            <span className="block text-red-600 font-bold font-serif" style={{ fontSize: `${boxSize * 0.35}px` }}>{localScore}</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // -----------------------
        // å¯«å­—ç·´ç¿’å€å¡Š
        // -----------------------
        const WordPractice = ({ wordData, onWordComplete }) => {
            const chars = wordData.word.split('');
            const [resetSignal, setResetSignal] = useState(0);
            const [scores, setScores] = useState({});
            const [completedIndices, setCompletedIndices] = useState(new Set());

            const handleScoreChangeIndexed = (index, score) => setScores(p => ({ ...p, [index]: score }));
            const handleCharComplete = (index) => {
                setCompletedIndices(p => {
                    const n = new Set(p); n.add(index);
                    if (n.size === chars.length) onWordComplete(true);
                    return n;
                });
            };
            const calculateAverage = () => {
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                return chars.length === 0 ? 0 : Math.round(total / chars.length);
            };

            useEffect(() => {
                const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set());
            }, [wordData]);

            return (
                <div className="flex flex-col items-center w-full">
                    <div className="w-full flex justify-between items-center bg-amber-100/50 px-4 py-2 rounded-lg mb-2">
                         <span className="text-xs text-gray-500 font-bold">ç¸½åˆ†</span>
                         <span className="text-xl font-bold text-amber-700 font-mono">{calculateAverage()}</span>
                    </div>
                    <div className="flex flex-wrap justify-center gap-1 md:gap-2 mb-2 w-full">
                        {chars.map((char, index) => (
                            <CharacterBox key={`${wordData.id}-${index}-${char}`} char={char} resetSignal={resetSignal}
                                onScoreChange={(c, s) => handleScoreChangeIndexed(index, s)} onComplete={() => handleCharComplete(index)} />
                        ))}
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => { setResetSignal(p => p + 1); const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set()); onWordComplete(false); }}
                            className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-bold transition shadow-sm">é‡å¯« (Reset)</button>
                    </div>
                </div>
            );
        };

        // -----------------------
        // ä¸»æ‡‰ç”¨ç¨‹å¼
        // -----------------------
        const App = () => {
            const [playerName, setPlayerName] = useState('');
            const [inputName, setInputName] = useState('');
            
            const [currentUnit, setCurrentUnit] = useState(null); 
            const [mode, setMode] = useState('welcome'); 
            
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [feedback, setFeedback] = useState(null); 
            const [quizOptions, setQuizOptions] = useState([]);
            const [canProceed, setCanProceed] = useState(false);
            const [audioSpeed, setAudioSpeed] = useState(1); 
            const [isSpeaking, setIsSpeaking] = useState(false);

            const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);

            const handleLogin = (e) => {
                e.preventDefault();
                if (inputName.trim()) {
                    setPlayerName(inputName.trim());
                    setMode('unit_select');
                }
            };

            const handleUnitSelect = (unit) => {
                // å¦‚æœå–®å…ƒæ²’æœ‰è©èªï¼Œä¸å…è¨±é€²å…¥
                if (unit.words.length === 0) {
                    alert("æ­¤èª²å ‚å…§å®¹å°šæœªæ›´æ–°ï¼Œè«‹ç¨å¾Œå†ä¾†ï¼");
                    return;
                }
                setCurrentUnit(unit);
                setMode('menu');
            };

            const startStudy = () => { setMode('study'); setCurrentIndex(0); setCanProceed(false); };
            const startQuiz = () => { setMode('quiz'); setScore(0); setCurrentIndex(0); setShowResult(false); prepareQuizRound(0); };

            const prepareQuizRound = (index) => {
                if (!currentUnit) return;
                const vocabList = currentUnit.words;
                if (index >= vocabList.length) { setShowResult(true); return; }
                const correctWord = vocabList[index];
                
                // ç”¢ç”Ÿé¸é …é‚è¼¯
                let options = vocabList.filter(v => v.id !== correctWord.id);
                // å¦‚æœç¸½è©æ•¸å°‘æ–¼4å€‹ï¼Œå°±ç”¨æ‰€æœ‰è©ç•¶é¸é …ï¼Œå†æ´—ç‰Œ
                if (options.length > 3) {
                    options = shuffleArray(options).slice(0, 3);
                }
                options.push(correctWord);
                setQuizOptions(shuffleArray(options));
            };

            const handleQuizAnswer = (selectedWord) => {
                if (!currentUnit) return;
                const currentWord = currentUnit.words[currentIndex];
                if (selectedWord.id === currentWord.id) {
                    setScore(score + 10);
                    setFeedback('correct');
                } else {
                    setFeedback('wrong');
                }
                setTimeout(() => {
                    setFeedback(null);
                    const nextIndex = currentIndex + 1;
                    setCurrentIndex(nextIndex);
                    prepareQuizRound(nextIndex);
                }, 1000);
            };

            const playCantonese = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                setIsSpeaking(true);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK'; utterance.rate = audioSpeed; 
                const voices = window.speechSynthesis.getVoices();
                const cantoneseVoice = voices.find(v => v.lang === 'zh-HK' || v.name.includes('Cantonese'));
                if (cantoneseVoice) utterance.voice = cantoneseVoice;
                utterance.onend = () => setIsSpeaking(false);
                window.speechSynthesis.speak(utterance);
            };

            useEffect(() => { if (window.speechSynthesis) window.speechSynthesis.getVoices(); }, []);

            // æ ¹æ“šåˆ†æ•¸ç²å–è©•åƒ¹
            const getResultFeedback = (finalScore, totalScore) => {
                const percentage = (finalScore / totalScore) * 100;
                if (percentage >= 100) return { text: "å®Œç¾ï¼ä½ æ˜¯è©èªå¤§å¸«ï¼", emoji: "ğŸŒŸğŸ†ğŸ’¯" };
                if (percentage >= 80) return { text: "å¤ªæ£’äº†ï¼åšå¾—å¾ˆå¥½ï¼", emoji: "ğŸ‰âœ¨ğŸ˜Š" };
                if (percentage >= 60) return { text: "ä¸éŒ¯å–”ï¼ç¹¼çºŒåŠ æ²¹ï¼", emoji: "ğŸ’ªğŸ‘" };
                return { text: "åˆ¥æ°£é¤’ï¼Œå¤šç·´ç¿’æœƒæ›´å¥½çš„ï¼", emoji: "ğŸ“šğŸ”¥" };
            };

            // ==================
            // ä»‹é¢æ¸²æŸ“
            // ==================

            // 0. æ­¡è¿ç™»å…¥é 
            if (mode === 'welcome') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-amber-50">
                        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border-4 border-amber-200">
                            {/* åœ–ç‰‡å€åŸŸ */}
                            <div className="w-32 h-32 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center overflow-hidden border-4 border-amber-300 relative">
                                {/* æ™ºæ…§åœ–ç‰‡è¼‰å…¥é‚è¼¯ï¼š
                                    1. å„ªå…ˆå˜—è©¦è®€å–æœ¬åœ°çš„ "./profile.jpg"
                                    2. å¦‚æœæ‰¾ä¸åˆ° (onerror)ï¼Œè‡ªå‹•åˆ‡æ›å›ç¶²è·¯å¡é€šé ­åƒ
                                */}
                                <img 
                                    src="./profile.jpg" 
                                    onError={(e) => {
                                        e.target.onerror = null; 
                                        e.target.src = "https://ui-avatars.com/api/?name=Ms+Ni&background=fcd34d&color=fff&size=128";
                                    }}
                                    alt="Ms. Ni" 
                                    className="w-full h-full object-cover" 
                                />
                            </div>
                            
                            <h1 className="text-4xl text-amber-900 calligraphy-font text-center mb-1">è©èªå¤§å¸«</h1>
                            <h3 className="text-xl text-amber-600 font-bold text-center mb-6">Ms. Ni çš„èª²å ‚</h3>
                            
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} placeholder="è¼¸å…¥ä½ çš„åå­—" className="w-full px-4 py-3 text-lg rounded-xl border-2 border-amber-200 focus:outline-none bg-amber-50 text-center" required />
                                <button type="submit" className="w-full bg-amber-500 text-white text-xl py-3 rounded-xl font-bold shadow-md active:scale-95">é–‹å§‹éŠæˆ²</button>
                            </form>
                        </div>
                    </div>
                );
            }

            // 1. èª²å ‚é¸æ“‡é 
            if (mode === 'unit_select') {
                return (
                    <div className="min-h-screen flex flex-col items-center p-4 bg-amber-50">
                        <div className="w-full max-w-md animate-bounce-in">
                            <h2 className="text-3xl text-amber-900 calligraphy-font text-center mb-2">è«‹é¸æ“‡èª²å ‚</h2>
                            <p className="text-center text-amber-600 font-bold mb-6">ä½ å¥½ï¼Œ{playerName}</p>
                            
                            <div className="space-y-4">
                                {UNIT_DATA.map(unit => (
                                    <button 
                                        key={unit.id}
                                        onClick={() => handleUnitSelect(unit)}
                                        className={`w-full p-6 rounded-2xl shadow-md border-2 text-left flex flex-col gap-1 transition transform ${unit.words.length === 0 ? 'bg-gray-100 border-gray-200 opacity-70 cursor-not-allowed' : 'bg-white border-amber-100 hover:border-amber-400 hover:scale-105'}`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="text-xl font-bold text-amber-800">{unit.title}</span>
                                            {unit.words.length === 0 && <span className="text-xs bg-gray-300 text-gray-600 px-2 py-1 rounded">å³å°‡æ¨å‡º</span>}
                                        </div>
                                        {unit.subtitle && <span className="text-lg text-amber-600 font-bold">{unit.subtitle}</span>}
                                        <span className="text-sm text-gray-500">{unit.description}</span>
                                    </button>
                                ))}
                            </div>

                            <button onClick={() => setMode('welcome')} className="w-full mt-8 text-sm text-gray-400 underline">ç™»å‡º / è¿”å›</button>
                        </div>
                    </div>
                );
            }

            // 2. é¸å–®ä»‹é¢
            if (mode === 'menu') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-amber-50">
                        <div className="text-center w-full max-w-md animate-bounce-in">
                            <h1 className="text-3xl text-amber-900 font-bold mb-1">{currentUnit.title}</h1>
                            <h2 className="text-5xl text-amber-800 calligraphy-font mb-4">{currentUnit.subtitle}</h2>
                            <p className="text-lg text-gray-500 mb-8">{currentUnit.description}</p>
                            
                            <div className="space-y-4">
                                <button onClick={startStudy} className="w-full bg-emerald-500 text-white text-xl py-4 rounded-xl shadow-lg active:scale-95 font-bold flex items-center justify-center gap-2">
                                    å¯«å­—é“å ´ <span className="text-sm opacity-70">(Writing)</span>
                                </button>
                                <button onClick={startQuiz} className="w-full bg-orange-500 text-white text-xl py-4 rounded-xl shadow-lg active:scale-95 font-bold flex items-center justify-center gap-2">
                                    è©ç¾©æŒ‘æˆ° <span className="text-sm opacity-70">(Quiz)</span>
                                </button>
                            </div>
                            
                            <button onClick={() => setMode('unit_select')} className="w-full mt-8 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">
                                è¿”å›èª²å ‚åˆ—è¡¨
                            </button>
                        </div>
                    </div>
                );
            }

            // 3. å¯«å­—ç·´ç¿’æ¨¡å¼
            if (mode === 'study') {
                const vocabList = currentUnit.words;
                const wordData = vocabList[currentIndex];
                return (
                    <div className="h-screen flex flex-col bg-amber-50 overflow-hidden">
                        <div className="flex justify-between items-center px-4 py-2 bg-white shadow-sm shrink-0 z-10">
                            <button onClick={() => setMode('menu')} className="text-gray-500 font-bold text-sm">é€€å‡º</button>
                            <span className="text-lg font-bold text-amber-800">{currentIndex + 1} / {vocabList.length}</span>
                            <div className="w-8"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 pb-24">
                            <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-3 md:p-4">
                                <div className="flex flex-col md:flex-row gap-4">
                                    <div className="w-full md:w-1/3 flex flex-col gap-2">
                                        <div className="flex items-center justify-between md:justify-start gap-3">
                                            <h2 className="text-3xl md:text-4xl font-bold text-gray-800">{wordData.word}</h2>
                                            <div className="flex gap-2">
                                                <button onClick={() => playCantonese(wordData.word)} className={`p-2 rounded-full ${isSpeaking ? 'bg-amber-400' : 'bg-amber-100'}`}>ğŸ”Š</button>
                                                <button onClick={() => setAudioSpeed(audioSpeed === 1 ? 0.5 : 1)} className="px-2 py-1 text-xs bg-gray-100 rounded border border-gray-300">{audioSpeed === 1 ? 'æ­£å¸¸' : 'æ…¢é€Ÿ'}</button>
                                            </div>
                                        </div>
                                        <div className="text-sm font-bold text-amber-700 bg-amber-50 px-2 py-1 rounded w-fit">ç²µ: {wordData.jyutping}</div>
                                        <div className="text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-100"><span className="font-bold block text-xs text-gray-400 uppercase">Meaning</span>{wordData.meaning}</div>
                                        <div className="text-sm text-indigo-600 bg-indigo-50 p-2 rounded border border-indigo-100"><span className="font-bold block text-xs text-indigo-300 uppercase">English</span>{wordData.english_meaning}</div>
                                    </div>
                                    <div className="w-full md:w-2/3 border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-4">
                                        <WordPractice wordData={wordData} onWordComplete={setCanProceed} key={wordData.id} />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="shrink-0 p-3 bg-white border-t border-gray-200 flex justify-between items-center gap-4 z-20">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} disabled={currentIndex === 0} className={`px-4 py-3 rounded-xl font-bold text-sm ${currentIndex === 0 ? 'bg-gray-100 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>ä¸Šä¸€å€‹</button>
                            <button onClick={() => { if (currentIndex < vocabList.length - 1) { setCurrentIndex(currentIndex + 1); setCanProceed(false); } else { setMode('menu'); } }}
                                disabled={!canProceed} className={`flex-1 py-3 rounded-xl font-bold shadow-md transition text-lg flex justify-center items-center gap-2 ${canProceed ? 'bg-amber-600 text-white active:scale-95' : 'bg-gray-300 text-gray-500'}`}>
                                {!canProceed && "ğŸ”’ "} {currentIndex === vocabList.length - 1 ? 'å®Œæˆç·´ç¿’' : 'ä¸‹ä¸€å€‹'}
                            </button>
                        </div>
                    </div>
                );
            }

            // 4. æ¸¬é©—æ¨¡å¼
            if (mode === 'quiz') {
                const vocabList = currentUnit.words;
                
                // çµç®—ç•«é¢ (Result Screen)
                if (showResult) {
                    const totalPossibleScore = vocabList.length * 10;
                    const feedbackData = getResultFeedback(score, totalPossibleScore);

                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-amber-50">
                            <div className="bg-white p-8 rounded-3xl shadow-xl text-center w-full max-w-md border-4 border-amber-200 animate-bounce-in">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">{currentUnit.title} æŒ‘æˆ°å®Œæˆï¼</h2>
                                <p className="text-lg text-amber-600 font-bold mb-6">{playerName}</p>
                                
                                <div className="mb-8">
                                    <div className="text-6xl mb-2">{feedbackData.emoji}</div>
                                    <div className="text-5xl font-bold text-amber-600 mb-2">{score} åˆ†</div>
                                    <div className="text-gray-400 text-sm">æ»¿åˆ†ï¼š{totalPossibleScore}</div>
                                </div>
                                
                                <div className="bg-amber-50 p-4 rounded-xl mb-8">
                                    <p className="text-amber-800 font-bold text-lg">{feedbackData.text}</p>
                                </div>
                                
                                <button onClick={() => setMode('menu')} className="w-full bg-amber-500 text-white text-xl py-4 rounded-xl font-bold shadow-lg transform transition active:scale-95">
                                    è¿”å›èª²å ‚é¸å–®
                                </button>
                            </div>
                        </div>
                    );
                }

                // æ¸¬é©—é€²è¡Œä¸­
                const currentWord = vocabList[currentIndex];
                return (
                    <div className="h-screen flex flex-col bg-amber-50">
                        {/* Quiz Header with Exit Button */}
                        <div className="flex justify-between items-center px-4 py-2 bg-white shadow-sm shrink-0 z-10">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setMode('menu')} className="text-gray-500 font-bold text-sm">é€€å‡º</button>
                                <span className="bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm font-bold">Q {currentIndex + 1}</span>
                            </div>
                            <span className="font-bold text-gray-700">Score: {score}</span>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto">
                            <div className="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
                                <h3 className="text-xl text-gray-800 leading-loose mb-2 text-center">
                                    {currentWord.sentence.split('____').map((part, i) => (
                                        <span key={i}>{part}{i === 0 && <span className="inline-block w-16 border-b-2 border-orange-400 mx-1 text-transparent">?</span>}</span>
                                    ))}
                                </h3>
                                {/* English Hint */}
                                <p className="text-sm text-gray-500 text-center mb-6">Hint: {currentWord.english_meaning}</p>
                                
                                <div className="grid grid-cols-1 gap-3">
                                    {quizOptions.map((option) => (
                                        <button key={option.id} onClick={() => !feedback && handleQuizAnswer(option)} disabled={!!feedback} className={`p-4 text-lg font-bold rounded-xl border-2 transition flex items-center justify-center gap-2 ${feedback ? (option.id === currentWord.id ? 'bg-green-500 border-green-500 text-white' : 'bg-gray-100 text-gray-400') : 'bg-white border-amber-200 text-gray-700 hover:border-amber-400'}`}>
                                            {option.emoji && <span className="text-2xl">{option.emoji}</span>}
                                            {option.word}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>